<!doctype html>
<html lang="bg-BG">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  
  <!--Importing external html content -->
  <link rel="import" href="uzd.html">
  <link rel="import" href="microbiology.html">
  <link rel="import" href="common.html">
  
  <style>
      
    body, html {
        margin: 0;
        overflow: hidden;
        height:100%;
      }
    
    .no-spin::-webkit-inner-spin-button,
    .no-spin::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }   
    
    @media print {
      body, html {
        height: auto;
        overflow: visible;
      }
      body * {
        visibility: hidden;
      }
      
      div.tab-content, div.tab-content *, div.tab-pane.active, div.tab-pane.active * {
        visibility: visible;
      }
      
/*******************************************      
      div.tab-pane.active{
        position: absolute;
        left: 0;
        top: 0;
      }
********************************************/       
      form {
        height: auto;
      }
     
    }
    
    @page {
      size: A3;
      margin-top: 2cm;
      margin-bottom: 2cm;
    } 

  </style>
  <title>Д-р Арабаджикова</title>
</head>

<body>
  <nav class="navbar navbar-expand-sm navbar-light bg-light">
    <span class="navbar-brand d-none d-sm-block mb-0 h1">Меню:</span>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup">
			<span class="navbar-toggler-icon"></span>
		</button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <div class="nav nav-pills nav-tabs mr-auto flex-column flex-sm-row" id="nav-tab" role="tablist">
        <a class="nav-item nav-link active text-center" id="uzd" data-toggle="tab" href="#nav-uzd" role="tab" controls="data">УЗД</a>
        <a class="nav-item nav-link text-center" id="microbiology" data-toggle="tab" href="#nav-microbiology" role="tab" controls="data">Микробиология</a>
        <a class="nav-item nav-link text-center" id="nav-admin-tab" data-toggle="tab" href="#nav-admin" role="tab" controls="admin">Settings</a>
        <a class="nav-item nav-link text-center" id="nav-about-tab" data-toggle="modal" href="#nav-about" role="tab" data-target="#nav-about">About</a>
      </div>
    </div>
  </nav>
  <div class="container-fluid">
    <div class = "row">
      <div class = "col-3 flex-column d-none d-lg-flex d-print-none border">
        <div listHeader>
          <div class="d-flex justify-content-left mt-3" buttonsbar2>
            <button type="button" class="btn btn-primary mx-1" new>Нов</button>
            <button type="button" class="btn btn-primary mx-1" logout>Изход</button>
          </div>
          <hr class="mx-0">
          <label>Търсене</label>
          <input class = "form-control" type="text" id="patientSearchPrefix">
          <hr class="mx-0">
        </div>
        <div class="list-group" id="patientList"></div>
      </div>  
      <div class = "col border">
        <div class="tab-content mt-0">
          <form-common></form-common>
          <div class="tab-pane fade show active" id="nav-uzd" role="tabpanel">
            <div class="container d-flex flex-column px-0">
              <form-uzd></form-uzd>
              <div class="d-flex justify-content-around my-3" buttonsbar1>
                <button type="button" class="btn btn-lg btn-primary w-50 m-1 d-print-none" save>Запис</button>
                <button type="button" class="btn btn-lg btn-primary w-50 m-1 d-print-none" print>Печат</button>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="nav-microbiology" role="tabpanel">
            <div class="container d-flex flex-column px-0">
              <form-microbiology></form-microbiology>
              <div class="d-flex justify-content-around my-3" buttonsbar1>
                <button type="button" class="btn btn-lg btn-primary w-50 m-1 d-print-none" save>Запис</button>
                <button type="button" class="btn btn-lg btn-primary w-50 m-1 d-print-none" print>Печат</button>
              </div>
            </div>
          </div>          
          <div class="tab-pane fade" id="nav-admin" role="tabpanel">
            <div class="card" >
              <div class="card-body">
                <h5 class="card-title">Set up Email Templates</h5>
                <p class="card-text">Click buttons below to create email template based on current exam form.</p>
                <div class="btn-group" id="email_templates_setup_buttons_group">
                </div>
              </div>
            </div>            
<!--            <label  class="form-label">accessKeyId</label>
            <input type="text" class="form-control" id="accessKeyId">
            <label  class="form-label">secretAccessKey</label>
            <input type="text" class="form-control" id="secretAccessKey">
            <button type="button" class="btn btn-lg btn-primary" access>Запис</button>
-->
          </div>
          <div class="modal fade" id="nav-about" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" >About...</h5>
                  <button type="button" class="close" data-dismiss="modal" >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>Д-р Арабаджикова v2.0.0<br>
                  BelianovSoft &copy 2018</p>
                  <p>
                    Change log:<br>
                    v2.0.0 - Exam forms are now implemented as custom html element loaded from external file.
                    v1.3.0 - Access to patient data is now with username and password.
                  </p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>          
        </div>
      </div>
    </div>
  </div>
  
  <!-- gerneral purpose modal dialog for showing info messages-->
  <div class="modal fade" id="modalInfo" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p></p>
        </div>
        <div class="modal-footer"></div>
      </div>
    </div>
  </div>
  <script>
    function showInfo(title, content, callback = null){
      $("div.modal#modalInfo h5.modal-title").html(title);
      $("div.modal#modalInfo div.modal-body p").html(content);
      $("div.modal#modalInfo div.modal-footer").html("");
      $("div.modal#modalInfo").off("hidden.bs.modal");
      $("div.modal#modalInfo div.modal-footer").append('<button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" close>Close</button>');
      if (callback && typeof callback == 'function'){
        $("div.modal#modalInfo div.modal-footer").append('<button type="button" class="btn btn-primary btn-sm" ok>OK</button>');
        $("div.modal#modalInfo div.modal-footer button[ok]").click(function(){
          $("div.modal#modalInfo").modal('hide');
          $("div.modal#modalInfo").one("hidden.bs.modal", function(){
             callback();
          });
        });
      }
      $("div.modal#modalInfo").modal('show');
    }
  </script>
  
  <!--Login modal dialog -->
  <div class="modal fade" id="modalLogin" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Log-in Dialog</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
              <label for="user-name" class="col-form-label">User:</label>
              <input type="text" class="form-control" id="user-name">
            </div>
            <div class="form-group">
              <label for="password" class="col-form-label">Password:</label>
              <input type="password" class="form-control" id="password"></input>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" ok>Log-in</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    function requestUserLoginInfo(cb_dynamoDB_op /*DynamoDB operation to be executed as callback after login*/){
      //clear the password field to show the user we do not like his password
      $("div.modal#modalLogin input#password").val("");
      $("div.modal#modalLogin div.modal-footer button[ok]").one("click", function(){
          $("div.modal#modalLogin").modal('hide');
          $("div.modal#modalLogin").one("hidden.bs.modal", function(){
             executeDdbOperation(cb_dynamoDB_op);
          });
        });
      $("div.modal#modalLogin").modal("show");
    
    }
  </script>
  
  <!-- unnecessary when using custom HTML elements
  <script>
    var links = document.querySelectorAll('link[rel="import"]');
    links.forEach(function(link){
      var content = link.import;
      console.log(content);
      var form = content.querySelector("form");
      if (form){
        var target = "form#"+form.getAttribute("id");
        var placeHolder = document.querySelector("div.form-place-holder[target='"+target+"']");
        if (placeHolder)
          placeHolder.appendChild(form.cloneNode(true));
      }
    });

  </script>
  <!------------------------------------------------>
  
  
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.203.0.min.js"></script>
  <!--<script src="ga_dating_functions.js"></script>-->
  <script src="js/amazon-cognito-identity.js"></script>
  

  
  <script>
    
		AWS.config.update({region: "us-east-1"});//, dynamoDbCrc32: false});
		//AWS.config.update({accessKeyId: '', secretAccessKey: ''});
    
    var wsUri = "wss://klbzi4x813.execute-api.us-east-1.amazonaws.com/Prod";
    var ws;

    
    var patientRetentionPeriod = 10; //years
    var accessKeyId = localStorage.getItem("accessKeyId");
    var secretAccessKey = localStorage.getItem("secretAccessKey");
    var poolData = { 
          UserPoolId : 'us-east-1_njMWzfgEG',
          ClientId : '2p3alhctu4e6d4fkunpctc8qd'
        };
    var credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: 'us-east-1:0ee125bb-925d-4880-9623-109b25e17574',
          Logins: {
            'cognito-idp.us-east-1.amazonaws.com/us-east-1_njMWzfgEG': ''
          }
        });
    var alexaMessageHandlers = []; //reference to functions interested in Alexa messages will be stored here
    
    //will be used to properly handle authenitacation flow
    //true, means that refreshng credential is not possible
    var credentialsRefreshFailed = true;
    
//     function getDynamoDB(){
//       var dynamodb = new AWS.DynamoDB({
//           apiVersion: '2012-08-10',
//           dynamoDbCrc32: false,
//           accessKeyId: accessKeyId,
//           secretAccessKey: secretAccessKey
//         });          
//       return dynamodb;
//     }
    
    function propagatePatientList(){
      $("div#patientList").html("");
      readPatientDB();
    }
    
    function readPatientDB(start_key){
      
      var params = {
        TableName: "patientDDB",
        ProjectionExpression: "patientName",
        Limit: 25,
      };  
      
      var search_prefix = $("input#patientSearchPrefix").val().toUpperCase();
      if (search_prefix.length > 0 ){
        params.ExpressionAttributeValues = {":prefix" : {S: search_prefix}};
        params.FilterExpression = "begins_with(patientName, :prefix)";
      }
      
      if (start_key != undefined)
        params.ExclusiveStartKey = start_key;
      
      executeDdbOperation(function(ddb){
        ddb.scan(params, function(err, data){
             if (err) console.warn(err, err.stack); // an error occurred
             else {
               console.debug(data);           // successful response
               data.Items.forEach(function (item){
                 $("div#patientList").append('<a href="#" class="list-group-item list-group-item-action py-0" data-toggle="list">'+item.patientName.S+'</a>');
               });

               //by default resul set from scan operation is limited to only fist 25 items.
               //uncomment following line to get all the item from the scan operations
               //if (data.LastEvaluatedKey != undefined) readPatientDB(data.LastEvaluatedKey); else 

               //once we are done, hook up event listener on every list item
                  $("div#patientList a").click(function(e){
                    e.preventDefault();
                    patientListItemClickedHandler($(this).html());
                  });
             }
        });
      });
    }
    
    function patientListItemClickedHandler(patientId){
      
      var params = {
        TableName: "patientDDB",
        Key: {
          "patientName" : {S: patientId}
        }
      }
      
      executeDdbOperation(function (ddb){
        ddb.getItem(params, function(err, data){
            if (err) console.warn(err, err.stack);  // an error occurred
            else {
              console.debug(data);                  // successful response
              visualizeExamData(data);
            }
        });
      });
    }
    
    function visualizeExamData(data){
      examType = data.Item.examType.S;
      
      if (examType == undefined){
        showInfo("Грешка", "Не дефиниран тип данни!");
        return;
      }
      var form = $("form#"+examType);
      var tab_pane = $("form#"+examType).parents("div.tab-pane");
      if (tab_pane == undefined || form == undefined){
        showInfo("Грешка", "Неизвестен тип данни");
        return;
      }
      
      $("a.nav-item#"+examType).tab("show");
      
      var examData = data.Item.examData.M;
      if (examData == undefined){
        showInfo("Грешка", "Неизвестен тип данни");
        return;        
      }
      
      form.find("input").val(""); //clear old data from all input fields before populatig data
      $("form-common").find("input").val(""); //TODO: avoid using "div[common]" as selector as it isin conflict with loosly coupled principles
      for (key in examData){
        console.debug (key, examData[key].S);
        form.find("input#"+key).val(examData[key].S);
        $("form-common").find("input#"+key).val(examData[key].S);//TODO: avoid using "div[common]" as selector as it isin conflict with loosly coupled principles
      };
      
      
    }
             
    
    function generateItemObject(form_id){
      var patientData = {};
      
      patientData.patientName = {S:$("form-common input#patient_name").val().toUpperCase()+" - "+
                                 $("form-common input#patient_egn").val()+"<br>"+
                                 $("a.nav-item#"+form_id).text() + " on " + 
                                 $("form-common input#exam_date").val()};
                                 //(new moment()).format("YYYY-MM-DD")};
      patientData.ttl = {N:(new moment()).add(patientRetentionPeriod, 'y').unix()+""};
      patientData.examType = {S:form_id};
      patientData.examData = {M:{}};
      $("form-common input").each(function(){
        var key = $(this).attr('id');
        var value = $(this).val();
        if (value != "")
          patientData.examData.M[key]={S:value};
      });      
      $("form#"+form_id+" input").each(function(){
        var key = $(this).attr('id');
        var value = $(this).val();
        if (value != "")
          patientData.examData.M[key]={S:value};
      });
         
      return patientData;
    }
    
    $("button[save]").click(function() {
      savePatientInfo(true /*overwrite protect*/);
    });
    
    function savePatientInfo(overwriteProtect) {
      var form_id = $(this).parents("form").attr("id");
      if (form_id == undefined)
          form_id = $("div.tab-pane.active form").attr("id");
      var patient_name = $("form-common input#patient_name").val();
      var patient_egn  = $("form-common input#patient_egn").val();
      
      if (patient_name.length == 0){// || patient_egn.length == 0) {
        showInfo("Липсваща информация", "Моля въведете име на пациент!")
        //alert("Моля въведете име на пациент!");
        return;
      }
      
      
      var item = generateItemObject(form_id);
      var params = {};
      params.TableName = "patientDDB";
      params.Item = item;
      if (overwriteProtect)
        params.ConditionExpression = "attribute_not_exists(patientName)"

      //uncomment next line if you want to get old item when putItem replaces existing item in DynamoDB
      //params.ReturnValues = "ALL_OLD";
      
      $("button[save]").prop("disabled", true);
       
      executeDdbOperation(function(ddb){
        ddb.putItem(params, function(err, data){
          $("button[save]").prop("disabled", false);
          if (err){
            console.warn("Error writing data in DB. error.code => ", err.code);
            if (err.code == "ConditionalCheckFailedException")
              showInfo("Внимание", "Вероятно дублиран запис.<br>Да продължа ли?", 
                       function(){ savePatientInfo(false /*no overwrite protect*/);});
            else
              showInfo("Грешка", "Грешка при запис!");
          }
          else{
            console.log("Data succesfully logged in DB", data);
            showInfo("Информация", "Успешен запис!");
          }

        });
      });
    };
    
    $("button[print]").click(function(){
      var h = $("form").css("height"); //temporary store the height property      
      $("form").css("height","");      
      window.print();      
      $("form").css("height",h);
    });
    
    function newPatient(){
      $("div.tab-pane.active input").val("");
      $("input#exam_date").val(new moment().format("YYYY-MM-DD"));
    }
    
    $("button[new]").click(function(){
      newPatient();
    });
    
    $("button[logout]").click(function(){
      var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
      var cognitoUser = userPool.getCurrentUser();
      
      if (cognitoUser != null){
        cognitoUser.signOut();
      }
    })
    
    $("button[access]").click(function(){
      var secretAccessKey = $("input#secretAccessKey").val();
      var accessKeyId = $("input#accessKeyId").val();
      
      if (secretAccessKey.length > 0 && accessKeyId.length > 0){
        localStorage.setItem("secretAccessKey", secretAccessKey);
        localStorage.setItem("accessKeyId", accessKeyId);
      }
    });
    
    $("input#patientSearchPrefix").keyup(function(e){
      if (e.which == 13) { //Enter pressed
        var s = $(this).val();
        if (s.length >= 0)
          propagatePatientList();
      }
    });
    
    
    function setupScrollers (){
      //sets up individual scrollers for left and right panes
      var navbar_outer_height = $("nav.navbar").outerHeight(true);
      var buttonsbar_outer_height = $("div[buttonsbar1]").outerHeight(true);
      var listHeader_outer_heigth = $("div[listHeader]").outerHeight(true);
      var div_common_outer_heigth = $("div[common]").outerHeight(true);

      var offset = navbar_outer_height+buttonsbar_outer_height+div_common_outer_heigth;
      $("form").css("height","calc(100vh - "+offset+"px");
      $("form").css("overflow-y","auto");
      
      offset = navbar_outer_height+listHeader_outer_heigth+10;
      $("div.list-group").css("height","calc(100vh - "+offset+"px");
      $("div.list-group").css("overflow-y","auto");
      
    }
    
    //Executes DynamoDB operation passed as argument. 
    //If needed user is asked for credentials
    function executeDdbOperation(op){
      console.debug("Start executing DynamoDB operation...");
      var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
      var dynamodb = new AWS.DynamoDB({
            apiVersion: '2012-08-10',
            dynamoDbCrc32: false,
            credentials: credentials,
          }); 
      
      if (credentials.needsRefresh()){
        console.log("Existing AWS credentials needs to be refreshed!");
        if (credentialsRefreshFailed)
          startAutheticationFlow();
        else{
          console.debug("Initiating AWS credentials refresh operation...");
          credentials.refresh((error) => {
              if (error) {
                console.error("Unable to refresh AWS credentials. Error: ", error);
                user.signOut();
                credentialsRefreshFailed = true;
                requestUserLoginInfo(op)
              } 
              else {
                console.debug('AWS credentials succesfully refreshed: ', credentials);
                credentialsRefreshFailed = false;
                if (op) op(dynamodb);

              }
          }); 
        }
      }
      else 
        //credentials seems valid, so execute requested dynamodb operation
        if (op) op(dynamodb);
      
      function startAutheticationFlow(){  
        console.debug("Tring to get current user from local browser storage...");
        var cognitoUser = userPool.getCurrentUser();

        if (cognitoUser == null)
          authenticateUser(userPool);
        else{
          console.debug("User succesfully retreived from local storage", cognitoUser);
          getAWSCredentials(cognitoUser);
        }
      }

      function authenticateUser(userPool){
        console.debug("No logged user found in local storage.");
        console.debug("User needs to enter his username and password...");
        
          var password = $("div.modal#modalLogin input#password").val();
          var user = $("div.modal#modalLogin input#user-name").val();
          
          if (password.length == 0){
              //we do not know the user password so ask for it.
              //pass as a parameter the intended DynamoDB operation 
              //After user enters his password we will try to execute it again.
              requestUserLoginInfo(op);
              return;
          }
          var authenticationData = {
                  Username : user,
                  Password : password,
              };
          var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);

          var userData = {
                  Username : authenticationData.Username,
                  Pool : userPool
              };

          var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
          //as we authenitcate new user, we clear any cached identities, just in case...
          credentials.clearCachedId();
        
          console.debug ("Authenticating new username and password");
        
          cognitoUser.authenticateUser(authenticationDetails, {
            onSuccess: function (result) {
              console.debug("User succesfully authenticated!", result);
              var idToken = result.idToken.jwtToken;
              credentials.params.Logins['cognito-idp.us-east-1.amazonaws.com/us-east-1_njMWzfgEG'] = 
                    idToken;
              console.debug("Requesting new AWS credentials...")
              credentials.get(function(error){
                    if (error) {
                      console.error("Requesting AWS credentials failed. Error: ", error);
                      cognitoUser.signOut();
                      credentialsRefreshFailed = true;
                      requestUserLoginInfo(op)
                    } 
                    else {
                      console.debug('AWS credentials succesfully obtained: ', credentials);
                      credentialsRefreshFailed = false;
                      if (op) op(dynamodb);
                    }
                });

              //var accessToken = result.getAccessToken().getJwtToken();
              /* Use the idToken for Logins Map when Federating User Pools with identity pools or when passing through an Authorization Header to an API Gateway Authorizer */
              //var idToken = result.idToken.jwtToken;
            },
            newPasswordRequired: function(userAttributes, requiredAttributes) {
              console.debug("New user. Password needs to be confirmed.");
                // User was signed up by an admin and must provide new 
                // password and required attributes, if any, to complete 
                // authentication.

                // userAttributes: object, which is the user's current profile. It will list all attributes that are associated with the user. 
                // Required attributes according to schema, which don’t have any values yet, will have blank values.
                // requiredAttributes: list of attributes that must be set by the user along with new password to complete the sign-in.

                // Get these details and call 
                // newPassword: password that user has given
                // attributesData: object with key as attribute name and value that the user has given.
                var attributesData = {};
                var newPassword = password;
                cognitoUser.completeNewPasswordChallenge(newPassword, attributesData, this);
            },        
            onFailure: function(err) {
              console.log("User authentication failure:", err.message, err);
              //showInfo("Грешка", "Грешка при оторизация.<br>Въведохте ли вярна парола?");
              //user have entered wrong password. clear it and re-attempt to execute to op again
              requestUserLoginInfo(op);
            }
          });
        }

      function getAWSCredentials(user){

          if (user != null) {
            user.getSession(function(err, session) {
              if (session && session.isValid()) {
                console.debug('Valid user session was retrieved:');
                console.debug("session: ", session);

                credentials.params.Logins['cognito-idp.us-east-1.amazonaws.com/us-east-1_njMWzfgEG'] = 
                    session.getIdToken().getJwtToken();
                
                //call refresh method in order to authenticate user and get new temp credentials
                
                console.log("Refreshing AWS credentials for the retrieved user session...");
                credentials.refresh((error) => {
                    if (error) {
                      console.error("Unable to refresh AWS credentials. Error: ", error);
                      user.signOut();
                      credentialsRefreshFailed = true;
                      requestUserLoginInfo(op)
                    } 
                    else {
                      console.debug('AWS credentials succesfully refreshed: ', credentials);
                      credentialsRefreshFailed = false;
                      if (op) op(dynamodb);
                    }
                });
              }
              else {//(session && session.isValid())
                console.error("Unable to retrieve user session for user: ", user);
                console.error("following error occurred", err);
                //showInfo("Грешка", "Възникна грешка.<br>Презаредете страницата и опитайте отново!")
                user.signOut();
                requestUserLoginInfo(op)
              }
            });
          }
          else { //(user != null)
            console.error("Unrecoverable error. Unable to retrieve user session for null user");
            showInfo("Грешка", "Възникна грешка.<br>Презаредете страницата и опитайте отново!");
          }
        }
    }
    
    function createEmailTemplatesSetupButtons(){
      var placeHolder = $("div.btn-group#email_templates_setup_buttons_group");
      $("a.nav-item:not([id|='nav'])").each(function(){
        var form_id = $(this).attr("id");
        var $button = $('<button type="button" class="btn btn-primary">'+$(this).text()+'</button>');
        $button.click(function(){
          var body_text= "";
          var body_html="";
          $("form-common input").each(function(){  
            var id = $(this).attr("id");
            var label = $("label[for="+id+"]").text();
            body_html += label + ": {{#if " + id +"}} {{" + id + "}} {{/if}}<br>";
            body_text += label + ": {{#if " + id +"}} {{" + id + "}} {{/if}}\r\n";
          });
          $("form#"+form_id+" input").each(function(){
            var id = $(this).attr("id");
            var label = $("label[for="+id+"]").text();
            body_html += label + ": {{#if " + id +"}} {{" + id + "}} {{/if}}<br>";
            body_text += label + ": {{#if " + id +"}} {{" + id + "}} {{/if}}\r\n";
          })
          var template = {
                            Template:{
                              TemplateName:form_id,
                              SubjectPart:"Вашето изследване " + $(this).text(),
                              HtmlPart:body_html,
                              TextPart:body_text
                            }
          };
          console.debug("template: ", template);
          var ses = new AWS.SES({
                credentials: credentials,
              }); 

          ses.deleteTemplate({TemplateName:form_id}, function(err, data) {
            if (err) console.log(err, err.stack); // an error occurred
            else     console.log(data);           // successful response
          
            ses.createTemplate(template, function(err, data) {
              if (err) console.log(err, err.stack); // an error occurred
              else     console.log(data);           // successful response
            });
          });
          
          //console.log("body ", body_html);

        });
        placeHolder.append($button);
        
      });
    }
    
    function setupWebsocketConnection(){
      ws = new WebSocket(wsUri);
      ws.onopen = function(evt){
        console.log("Wesocket CONNECTED");
        alexaMessageHandlers.forEach(function(handler){
          handler('connected', null);
        });        
      }
      
      ws.onclose = function(evt){
        console.log("Webscoket DICONNECTED");
        alexaMessageHandlers.forEach(function(handler){
          handler('disconnected', null);
        });          
      }
      
      ws.onerror = function(evt) {
        console.warn("Webscoket ERROR");
        console. debug(evt.data);  
        alexaMessageHandlers.forEach(function(handler){
          handler('disconnected', null);
        });          
      }
      
      ws.onmessage = function(evt){
        console.log("got WS event:", evt.data);
        activeFormId= $("div.tab-pane.active form").attr("id");
        alexaMessageHandlers[activeFormId]('message', JSON.parse(evt.data));
      }
      
    }
    
    function registerAlexaEventHandler(_key, handler){ //the _key parameter will be used to pass the event only to that handler whose form is currenlty active.
      if (handler && typeof(handler) === "function")
        alexaMessageHandlers[_key] = handler;
    }
    
    $(function(){
      propagatePatientList();
      newPatient();
      setupScrollers();
      createEmailTemplatesSetupButtons();
      //executeDdbOperation(null);
      setupWebsocketConnection();
    });
    
  </script>
</body>
</html>